#!/usr/bin/env nu

#MISE description="Add a formula or cask to the Brewfile"

def main [
  name: string       # The name of the formula
  --tap (-t): string # If there's a tap, use this
  --cask (-c)        # Use this flag to save a cask
]: nothing -> nothing {
  mut lines = []

  let path = "Brewfile"
  let brewfile = open $path

  if ($tap | is-not-empty) {
    let line = $'tap "($tap)"'
    if not ($brewfile =~ $line) {
      $lines ++= [$line]
    }
  }

  let line = match $cask {
    true => 'cask',
    _ => 'brew'
  }
  | $'($in) "($name)"'

  if ($brewfile !~ $line) {
    $lines ++= [$line]
  }

  $lines | prepend ['\n']
  | str join (char newline)
  | $"\n($in)"
  | save -a $path
}
