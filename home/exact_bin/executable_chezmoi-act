#!/usr/bin/env bash

set -euo pipefail

function choose() {
  fzf --multi \
    --exit-0 \
    --bind 'ctrl-a:toggle-all' \
    --bind 'enter:accept-non-empty' \
    --bind 'start:select-all' \
    --prompt "$1" \
    --accept-nth "$HOME/{2}" \
    --nth '2..' \
    --print0 \
    --preview "chezmoi diff $HOME/{2}"
}

function main() {
  if
    chezmoi status --include templates |
      rg '^MM' |
      choose "Merge templates: " |
      xargs --null \
        --no-run-if-empty \
        pueue add -- chezmoi merge &>/dev/null
  then
    gum spin --title "Merging..." -- pueue wait
    gum log -l info "Templates merged."
  else
    gum log -l warn "No templates to merge."
  fi

  if
    chezmoi status --exclude templates |
      rg '^MM' |
      choose "Re-add: " |
      xargs --null \
        --no-run-if-empty \
        pueue add -- chezmoi re-add &>/dev/null
  then
    gum spin --title "Re-adding..." -- pueue wait
    gum log -l info "Files re-added."
  else
    gum log -l warn "No files to re-add."
  fi

  if
    chezmoi status --exclude templates |
      rg '^DA' |
      choose "Forget missing: " |
      xargs --null \
        --no-run-if-empty \
        pueue add -- chezmoi forget --force &>/dev/null
  then
    gum spin --title "Forgetting..." -- pueue wait
    gum log -l info "Files forgotten."
  else
    gum log -l warn "No files to forget."
  fi

  if
    chezmoi status --exclude templates |
      rg '^ D' |
      choose "Add deleted: " |
      xargs --null \
        --no-run-if-empty \
        pueue add -- chezmoi add &>/dev/null
  then
    gum spin --title "Adding..." -- pueue wait
    gum log -l info "Files added."
  else
    gum log -l warn "No files to add."
  fi

}

main
