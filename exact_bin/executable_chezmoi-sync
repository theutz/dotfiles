#!/usr/bin/env zsh -euo pipefail

local readd=()
local destroy=()
local apply=()

while read -r stat file; do
  case $stat in
    MM)
      gum log -l info --prefix "re-add" " $file"
      readd+="$file"
      ;;
    DA)
      gum log -l warn --prefix destroy "$file"
      destroy+="$file"
      ;;
    D)
      gum log -l warn --prefix apply "  $file"
      apply+="$file"
      ;;
    *)
      gum log -l error --prefix "ERROR" "unknown status: $stat"
      gum log --prefix "$file"
      ;;
  esac
done <<< $(chezmoi status)

if
  (
    (( $#readd )) ||
      (( $#destroy )) ||
      (($#apply))
  ) && gum confirm "Proceed"
then
  (( $#readd )) && chezmoi re-add "${readd[@]}"
  (( $#destroy )) && chezmoi destroy "${destroy[@]}"
  (( $#apply )) && chezmoi apply "${apply[@]}"
fi

