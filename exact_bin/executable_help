#!/usr/bin/env zsh

set -euo pipefail

local dir="$XDG_CONFIG_HOME/help"
local config_file="$dir/help.yml"
local config="$(qq $config_file)"

if [[ "${#argv[@]}" == 0 ]]; then
  local sources="$(echo $config | jq -r '.sources | keys | join(", ")')"
  echo "help [SOURCE]

SOURCE: ${sources}
  "
  exit
fi

if [[ $argv[1] == "add" ]]; then
  local source="${argv[2]}"
  local action="${argv[3,0]}"
  qq -r --arg source $source --arg action $action '.sources[$source] = $action' $config_file | sponge $config_file
  exit
fi

local source="${(j: :)argv[@]}"
local action="$(echo $config | jq -r --arg source $source '.sources[$source]')"

echo "Running '$action'"
eval "$action"
