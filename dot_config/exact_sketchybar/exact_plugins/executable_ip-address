#!/usr/bin/env -S ${HOME}/.local/bin/mise exec aqua:nushell/nushell -- nu
# vim: ft=nu

plugin add nu_plugin_query
plugin use query

let page = http get https://am.i.mullvad.net

let data = $page
  | query web --query '.results p:nth-child(2)'
  | flatten
  | get 0
  | parse --regex r#'IP address: (?<ip>.*?), (?<location>.*)'#
  | update cells { str trim }
  | first

let is_mullvad = $page | query web --query '.results.mullvad'
  | get 0?
  | is-not-empty

[
  --animate sin 10
] | if ($data | is-not-empty) {
  append [
    --set ipaddress
    icon.highlight=off
    label=($data.ip)
    label.drawing=on

    --set iplocation
    icon.highlight=off
    drawing=on
    label=($data.location)
  ]
} else {
  [
    --set ipaddress
    icon.highlight=on
    
    --set iplocation
    drawing=off
  ]
}
| append [
    --set tailscale
    icon.highlight=(if $is_mullvad { 'off' } else { 'on' })
]
| sketchybar ...$in

