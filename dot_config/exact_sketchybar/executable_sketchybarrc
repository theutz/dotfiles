#!/usr/bin/env -S mise x aqua:nushell/nushell@0.106.1 -- nu
# vim: ft=nu

$env.PLUGIN_DIR = $env.CONFIG_DIR | path join plugins
$env.FONT = "BlexMono Nerd Font Propo"
use catppuccin.nu

def clr [name: string, alpha: string = "FF"]: nothing -> string {
  catppuccin color $name --argb --alpha=$alpha
}

[
  --bar
  blur_radius=20
  color=(clr surface0 88)
  height=40
  notch_width=216
  position=top

  --default
  alias.color=(clr peach)
  alias.scale=1.0
  background.color=(clr green 44)
  background.corner_radius=5
  background.drawing=off
  background.height=24
  icon.color=(clr pink)
  icon.font=($env.FONT):Normal:18.0
  icon.highlight_color=(clr green)
  icon.padding_left=6
  icon.padding_right=0
  label.color=(clr yellow)
  label.font=($env.FONT):Normal:16.0
  label.highlight_color=(clr green)
  label.padding_left=4
  label.padding_right=6
  padding_left=4
  padding_right=4
] | run-external sketchybar ...$in

## Setup  AeroSpace spaces
#args=(
#  --add event aerospace_workspace_change
#  --add item aerospace left
#  --set aerospace
#  script="$PLUGIN_DIR/aerospace.sh"
#  drawing=off
#  --subscribe aerospace aerospace_workspace_change
#)
#for sid in $(aerospace list-workspaces --all); do
#  args+=(
#    --add item space."$sid" left
#    --set space."$sid"
#    background.drawing=off
#    click_script="aerospace workspace $sid"
#    icon.color="$(sketchybar --query defaults | jq -r '.label.color')"
#    icon.font.size=12.0
#    icon="$sid"
#    label.color="$(sketchybar --query defaults | jq -r '.icon.color')"
#    label.font.size=12.0
#    label=•
#  )
#done
#
## Setup chevron
#args+=(
#  --add item chevron left
#  --set chevron
#  icon.color="$(color green)"
#  label.drawing=off
#  icon=""
#  click_script="open -a 'Mission Control'"
#)
#
## Setup front app
#args+=(
#  --add item front_app left
#  --set front_app
#  icon.drawing=off
#  script="$PLUGIN_DIR/front_app.sh"
#  label.color="$(color pink)"
#  --subscribe front_app front_app_switched
#)
#
## Setup AeroSpace Modes
#args+=(
#  --add event aerospace_mode_change
#  --add item aerospace.mode left
#  --subscribe aerospace.mode aerospace_mode_change
#  --set aerospace.mode
#  drawing=off
#  icon=""
#  icon.color="$(color cyan)"
#  label.color="$(color yellow)"
#  update_freq=1
#  script="$PLUGIN_DIR/aerospace_mode.sh"
#  click_script="aerospace mode main; sketchybar --trigger aerospace_mode_change MODE=main"
#)

[
  --add item clock right
  --set clock
  update_freq=10
  icon=󱑀
  script=($env.PLUGIN_DIR)/clock
] | sketchybar ...$in

[
  --add item volume right
  --set volume script=($env.PLUGIN_DIR)/volume
  display=active
  --subscribe volume volume_change
] | sketchybar ...$in

[
  --add item battery right
  --set battery
  display=active
  update_freq=120
  script=($env.PLUGIN_DIR)/battery
  --subscribe battery system_woke power_source_change
] | sketchybar ...$in

[
  "Tailscale,Item-0"
  "Control Center,WiFi"
  "TextInputMenuAgent,Item-0"
  "Control Center,FocusModes"
  "AeroSpace,Item-0"
] | each {|it|
  [
    --add alias $it right
    --set $it
    label.drawing=off
    icon.drawing=off
    padding_left=0
    padding_right=0
  ]
}
| flatten
| run-external sketchybar ...$in

[
  --add item spotify q
  --set spotify
  "click_script=spotify_player playback play-pause"
  display=1
  drawing=off
  icon.color=(clr green)
  icon= 
  label.color=(clr sky)
  label.font.size=12.0
  label.max_chars=40
  label.scroll_duration=300
  script="($env.PLUGIN_DIR)/spotify"
  scroll_texts=on
  update_freq=3
]
| run-external sketchybar ...$in

[
  --add item ipaddress e
  --set ipaddress
  script=($env.PLUGIN_DIR)/ip-address
  "click_script=open https://browserleaks.com/ip"
  display=1
  icon.color=(clr green)
  icon.highlight=on
  icon.highlight_color=(clr red)
  icon=󰩟 
  label.color=(clr sky)
  label.font.size=12.0
  script=($env.PLUGIN_DIR)/ip-address
  update_freq=3

  --add item iplocation e
  --set iplocation
  "click_script=open https://browserleaks.com/ip"
  display=1
  drawing=off
  icon.color=(clr green)
  icon.font.size=14.0
  icon.highlight=on
  icon=
  label.color=(clr sky)
  label.font.size=12.0
] | sketchybar ...$in

###### Force all scripts to run the first time (never do this in a script) #####
^sketchybar --update
print -e "Sketchybar updated!"
