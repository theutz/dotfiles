#
# Tmux Configuration
#

# Plugins {{{

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-yank'

if "test ! -d #{d:current_file}/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm #{d:current_file}/plugins/tpm && #{d:current_file}/plugins/tpm/bin/install_plugins'"
run "#{d:current_file}/plugins/tpm/tpm"

# }}}

# Options {{{

# User Styles {{{

set -g @fg 'colour15'
set -g @bg 'terminal'
set -g @pri 'colour12'
set -g @sec 'colour13'
set -g @warn 'colour3'
set -g @err 'colour1'
set -g @win 'colour2'
set -g @cool 'colour6'
set -g @dim 'colour8'
set -g @over 'colour0'
set -g @hi 'colour13'

# }}}

# Styles {{{

set -g cursor-style blinking-block
set -g menu-border-style 'fg=colour5'
set -g menu-selected-style "fg=#{E:@over} bg=#{E:@win}"
set -g message-command-style "fg=#{E:@cool} bg=#{E:@bg}"
set -g message-style "fg=#{E:@cool} bg=#{E:@bg} italics"
set -g pane-active-border-style "fg=#{E:@pri}"
set -g pane-border-style "fg=#{E:@dim}"
set -g popup-border-style "fg=#{E:@hi}"
set -g status-style "bg=#{E:@bg} fg=#{E:@dim}"
set -g status-left-style "fg=#{E:@pri}"
set -g window-status-current-style "fg=#{E:@pri}"
set -g window-status-last-style "fg=#{E:@cool}"
set -g window-status-style "fg=#{E:@dim} italics"

# }}}

# Formats {{{

set -g pane-border-format " #{?pane_active,,} #P#{?#T,:,}#{?#{==:#T,#H},,#T} #[fg=#{E:@dim}]#{s|$HOME|~|:pane_current_path} "

set -gu status-format[1]
set -ga status-format[1] "  #{s|$HOME|~|:pane_current_path}"
set -ga status-format[1] '#[align=absolute-centre]'
set -ga status-format[1] ' #[fg=#{E:@hi} italics] #[fg=default]#{host}'
set -ga status-format[1] ' #{window-status-separator} '
set -ga status-format[1] '#[fg=#{E:@hi}] #[fg=default]%Y-%m-%d'
set -ga status-format[1] ' #{window-status-separator} '
set -ga status-format[1] '#[fg=#{E:@hi}]#[fg=default] %H:%M'
set -ga status-format[1] '#[align=right]'
set -ga status-format[1] '#{?client_prefix,#[fg=#{E:@err}]#[reverse]󰧹 <C-b>#[noreverse]#[fg=default] ,}'

set -g status-left "   #S:#[fg=#{E:@dim}]#{s|$HOME|~|:session_path} #{session_alerts}"
set -g status-right "#{P: #{?pane_active,#[fg=#{?window_zoomed_flag,#{E:@hi},#{E:@pri}}],#[fg=#{?pane_last,#{E:@cool},#{E:@dim}} italics]} #{pane_index}:#{?#{==:#{pane_title},#{host}},,#{pane_title} }#{=/-20/.../:#{s|$HOME|~|:pane_current_path}} #[fg=default]}"
set -g window-status-current-format "󱏀 #I:#W #{?#F, #F,}"
set -g window-status-format "󰓫 #I:#W#{?#F, #F,}"
set -g window-status-separator ''

# }}}

# Aliases {{{

set -g command-alias[100] vsp="split-window -h"
set -g command-alias[101] sp="split-window -v"

# }}}

# Miscellaneous {{{

set -g aggressive-resize on
set -g allow-passthrough all
set -g base-index 1
set -g default-terminal "xterm-256color"
set -g destroy-unattached off
set -g detach-on-destroy off
set -g escape-time 0
set -g menu-border-lines rounded
set -g message-line 2
set -g mode-keys vi
set -g mouse on
set -g other-pane-width 80
set -g pane-base-index 1
set -g pane-border-indicators both
set -g pane-border-lines heavy
set -g pane-border-status top
set -g popup-border-lines rounded
set -g remain-on-exit off
set -g renumber-windows on
set -g set-titles on
set -g status on
set -g status-interval 1
set -g status-justify absolute-centre
set -g status-keys vi
set -g status-left-length 120
set -g status-position bottom
set -g status-right-length 120
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set -sa terminal-overrides ",xterm*:Tc"

# }}}

# }}}

# Hooks {{{

# after-split-window {{{
# set-hook -g after-split-window[100] {
#   command-prompt -i -I "#{pane_title}" -p 'Pane title:' {
#     select-pane -T '%%'
#     select-pane -T "#{s/^=//:pane_title}"
#   }
# }
# }}}

# after-new-window {{{
# set-hook -g after-new-window[100] {
#   command-prompt -I "#{pane_current_path},#{pane_title}" -p "Window title:,Pane title:" {
#     rename-window '%1'
#     select-pane -T '%2'
#   }
# }
# }}}

# }}}

# Bindings {{{

# Root {{{

# bind-key -N "Scroll page up" -T root 'copy-mode -eu'
set -g command-alias[1450] is-pane-dead='display -p "#{pane_dead}"'
bind -N "Enter (or respawn)" -n Enter if '[[ "$(tmux display -p "#{pane_dead}")" == 1 ]]' \
  respawn-pane \
  { send-keys Enter }
bind -N "q (or kill dead pane)" -n q if '[[ "$(tmux display -p "#{pane_dead}")" == 1 ]]' \
  kill-pane \
  { send-keys q }
# }}}

# Prefix {{{

# Miscellaneous {{{

unbind R
bind -N "Rename pane" v command-prompt -I "#{pane_title}" { selectp -T '%%' }
bind -N "Reload config" r source -F '#{config_files}' \; display "Config reloaded!"
bind -N "Clear screen" C-l send 'C-l'
bind -N "List all keys" / list-keys
bind -N "Respawn pane" R confirm-before -p "Respawn pane? (y/n)" "respawn-pane -k"
bind -N "Customize mode" O customize-mode -Z
bind -N "Kill server" Q confirm-before -p "Kill server? (y/n)" "kill-server"
bind -N "Cycle layouts" Space next-layout

# }}}

# Goto menu {{{

bind -N 'Open goto menu' g \
  menu -T 'Goto Menu' \
    buku b {
      popup -T 'buku' -E 'tmux attach -t buku'
    } config c {
      menu -T 'Config Menu' \
        aerospace a { 
          if '! tmux switchc -t main:aerospace.1' {
            neww -c ~/.config/aerospace -t main: -n aerospace nvim
            splitw -d -h w3m https://nikitabobko.github.io/AeroSpace/guide
          }
          set remain-on-exit on
          send s
        } hammerspoon h {
          if '! tmux switchc -t main:hammerspoon' {
            neww -c ~/.hammerspoon -t main: -n hammerspoon nvim
          }
          set -w remain-on-exit
        } nvim n {
          if '! tmux switchc -t main:nvim' {
            neww -c ~/.config/nvim -t main: -n nvim nvim
          }
          set -w remain-on-exit on
        } tmux t {
          if '! tmux switchc -t main:tmux.1' {
            neww -c ~/.config/tmux -t main: -n tmux nvim
            splitw -d -h 'man tmux'
          }
          set -w remain-on-exit on
          send s
        } wezterm w {
          if '! tmux switchc -t main:wezterm' {
            neww -c ~/.config/wezterm -t main: -n wezterm nvim
          }
          set -w remain-on-exit on
        }
    } tmux-control g {
      popup -T 'tmux-control' -E tmux-control
    } nb n {
      popup -h 90% -w 66% -y 0 -T nb -E 'tmux attach -t nb'
    } spotify_player p {
      popup -h 90% -w 66% -y 0 -T 'spotify' -E 'tmux attach -t spotify'
    } btop t {
      popup -h 100% -w 100% -T btop -h 90% -w 95% -E btop
    }
# }}}

# }}}

# }}}

# Sessions {{{

source -F "#{d:current_file}/sessions/main.conf"
source -F "#{d:current_file}/sessions/nb.conf"
source -F "#{d:current_file}/sessions/spotify.conf"
source -F "#{d:current_file}/sessions/buku.conf"

# }}}

# vim: ft=tmux fdm=marker fdl=0
