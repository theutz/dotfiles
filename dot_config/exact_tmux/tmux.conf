#
# Tmux Configuration
#

# Plugins {{{

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-yank'

if "test ! -d #{d:current_file}/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm #{d:current_file}/plugins/tpm && #{d:current_file}/plugins/tpm/bin/install_plugins'"
run "#{d:current_file}/plugins/tpm/tpm"

# }}}

# Options {{{

# User Styles {{{

set -g @fg 'colour15'
set -g @bg 'terminal'
set -g @pri 'colour12'
set -g @sec 'colour13'
set -g @warn 'colour3'
set -g @err 'colour1'
set -g @win 'colour2'
set -g @cool 'colour6'
set -g @dim 'colour8'
set -g @over 'colour0'
set -g @hi 'colour13'

# }}}

# Styles {{{

set -g cursor-style blinking-block
set -g menu-border-style 'fg=colour5'
set -g menu-selected-style "fg=#{E:@over} bg=#{E:@win}"
set -g message-command-style "fg=#{E:@cool} bg=#{E:@bg}"
set -g message-style "fg=#{E:@cool} bg=#{E:@bg} italics"
set -g pane-active-border-style "fg=#{E:@pri}"
set -g pane-border-style "fg=#{E:@dim}"
set -g popup-border-style "fg=#{E:@hi}"
set -g status-style "bg=#{E:@bg} fg=#{E:@dim}"
set -g status-left-style "fg=#{E:@pri}"
set -g window-status-current-style "fg=#{E:@pri}"
set -g window-status-last-style "fg=#{E:@cool}"
set -g window-status-style "fg=#{E:@dim} italics"

# }}}

# Formats {{{

set -g pane-border-format " #{?pane_active,,} #{pane_index}#{?#{pane_title},:,}#{?#{==:#{pane_title},#{host}},,#{pane_title}} #(echo '#{pane_current_path}' | sed \"s|^$HOME|~|\") "
set -g status-format[1] ' #[fg=#{E:@hi} italics align=absolute-centre] #[fg=default]#{host}#{window-status-separator}#[fg=#{E:@hi}] #[fg=default]%Y-%m-%d#{window-status-separator}#[fg=#{E:@hi}]#[fg=default] %H:%M #{?client_prefix,#[fg=colour1 align=right]#[reverse]󰧹 <C-b>#[noreverse]#[fg=default] ,}'
set -g status-left '   #S #[fg=#{E:@dim}]#{session_path} #{session_alerts}'
set -g status-right "#{P: #{?pane_active,#[fg=#{E:@pri}],#[fg=#{?pane_last,#{E:@cool},#{E:@dim}} italics]} #{pane_index}:#{?#{==:#{pane_title},#{host}},,#{pane_title} }#(echo '#{pane_current_path}' | sed 's|^$HOME|~|') #[fg=default]}"
set -g window-status-current-format "󱏀 #I:#W #{?window_flags,#{window_flags},}"
set -g window-status-format "󰓫 #I:#W #{?window_flags,#{window_flags},}"
set -g window-status-separator '  '

# }}}

# Aliases {{{

set -g command-alias[100] vsp="split-window -h"
set -g command-alias[101] sp="split-window -v"

# }}}

# Miscellaneous {{{

set -g aggressive-resize on
set -g allow-passthrough all
set -g base-index 1
set -g default-terminal "xterm-256color"
set -g destroy-unattached off
set -g detach-on-destroy off
set -g escape-time 0
set -g menu-border-lines rounded
set -g message-line 2
set -g mode-keys vi
set -g mouse on
set -g other-pane-width 80
set -g pane-base-index 1
set -g pane-border-indicators both
set -g pane-border-lines heavy
set -g pane-border-status top
set -g popup-border-lines rounded
set -g remain-on-exit off
set -g renumber-windows on
set -g set-titles on
set -g status on
set -g status-interval 1
set -g status-justify absolute-centre
set -g status-keys vi
set -g status-left-length 120
set -g status-position bottom
set -g status-right-length 120
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set -sa terminal-overrides ",xterm*:Tc"

# }}}

# }}}

# Hooks {{{

# after-split-window {{{
# set-hook -g after-split-window[100] {
#   command-prompt -i -I "#{pane_title}" -p 'Pane title:' {
#     select-pane -T '%%'
#     select-pane -T "#{s/^=//:pane_title}"
#   }
# }
# }}}

# after-new-window {{{
# set-hook -g after-new-window[100] {
#   command-prompt -I "#{pane_current_path},#{pane_title}" -p "Window title:,Pane title:" {
#     rename-window '%1'
#     select-pane -T '%2'
#   }
# }
# }}}

# }}}

# Bindings {{{

# Root {{{

# bind-key -N "Scroll page up" -T root 'copy-mode -eu'
set -g command-alias[1450] is-pane-dead='display -p "#{pane_dead}"'
bind -N "Enter (or respawn)" -n Enter if '[[ "$(tmux display -p "#{pane_dead}")" == 1 ]]' \
  respawn-pane \
  { send-keys Enter }
bind -N "q (or kill dead pane)" -n q if '[[ "$(tmux display -p "#{pane_dead}")" == 1 ]]' \
  kill-pane \
  { send-keys q }
# }}}

# Prefix {{{

unbind-key R

bind-key -N "Rename pane" v command-prompt -I "#{pane_title}" { select-pane -T '%%' }
bind-key -N "Reload config" r source -F '#{config_files}' # \; display-message "Config reloaded!"
bind-key -N "Clear screen" C-l send-keys 'C-l'
bind-key -N "List all keys" / list-keys
bind-key -N "Respawn pane" R confirm-before -p "Respawn pane? (y/n)" "respawn-pane -k"
bind-key -N "Customize mode" O customize-mode -Z
bind-key -N "Kill server" Q confirm-before -p "Kill server? (y/n)" "kill-server"

bind-key -N "Select layout" Space display-menu -xC -yS -T 'Choose layout...' \
  'even-horizontal' h 'select-layout even-horizontal' \
  'even-vertical' v 'select-layout even-vertical' \
  'main-horizontal' H 'select-layout main-horizontal' \
  'main-vertical' V 'select-layout main-vertical' \
  'tiled' t 'select-layout tiled'

# Goto menu {{{

bind -N 'Open goto menu' g \
  menu -T 'Goto Menu' \
    buku b {
      popup -T 'buku' -E 'tmux attach -t buku'
    } config c {
      menu -T 'Config Menu' \
        aerospace a { 
          if '! tmux switchc -t main:aerospace' {
            neww -c ~/.config/aerospace -t main: -n aerospace nvim
          }
          send s
        } hammerspoon h {
          if '! tmux switchc -t main:hammerspoon' {
            neww -c ~/.hammerspoon -t main: -n hammerspoon nvim
          }
          set -w remain-on-exit
        } nvim n {
          if '! tmux switchc -t main:nvim' {
            neww -c ~/.config/nvim -t main: -n nvim nvim
          }
          set -w remain-on-exit on
        } tmux t {
          if '! tmux switchc -t main:tmux.1' {
            neww -c ~/.config/tmux -t main: -n tmux nvim
            splitw -h 'man tmux'
            switchc -t .1
          }
          set -w remain-on-exit on
          send s
        } wezterm w {
          if '! tmux switchc -t main:wezterm' {
            neww -c ~/.config/wezterm -t main: -n wezterm nvim
          }
          set -w remain-on-exit on
        }
    } tmux-control g {
      popup -T 'tmux-control' -E tmux-control
    } nb n {
      popup -T nb -E 'tmux attach -t nb'
    } spotify_player p {
      popup -T 'spotify' -E 'tmux attach -t spotify'
    }
# }}}

# }}}

# }}}

# Sessions {{{

# main {{{

%if '#{?#{N/s:main},,true}'
  new -d -s main -n main
  set -t main status 2
%endif
# }}}

# nb {{{

%if '#{?#{N/s:nb},,true}'
  new -d -s nb -n main 'nb -i'
  selectp -T main -t nb:main.1
  set -t nb:main status off
  set -t nb pane-border-status off
  set -t nb remain-on-exit on
%endif
# }}}

# spotify {{{

%if '#{?#{N/s:spotify},,true}'
  new -d -s spotify -n main spotify_player
  selectp -T main -t spotify:main.1
  set -t spotify:main status off
  set -t spotify pane-border-status off
  set -t spotify remain-on-exit on
%endif
# }}}

# buku {{{

%if '#{?#{N/s:buku},,true}'
  new -d -s buku -n main buku
  selectp -T main -t buku:main.1
  set -t buku:main status off
  set -t buku pane-border-status off
  set -t buku remain-on-exit on
%endif
#}}}

# }}}

# vim: ft=tmux fdm=marker fdl=0
